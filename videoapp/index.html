<!DOCTYPE html>
<html>
<head>
    <title>Gaze Tracker</title>
</head>
<body style="font-family: monospace; text-align: center; background: white; color: black;">

    <h2>Gaze Detection</h2>
    <p>Look center for "FOCUS", look left/right for "BORED"</p>
    
    <div style="position: relative; display: inline-block;">
        <video id="webcam" autoplay playsinline style="transform: scaleX(-1); width: 640px; height: 480px; background: #eee; border: 1px solid #000;"></video>
        <canvas id="canvas" style="position: absolute; top: 0; left: 0; transform: scaleX(-1); width: 640px; height: 480px;"></canvas>
    </div>

    <div style="margin: 20px;">
        <button onclick="startCamera()">START</button>
        <button onclick="stopCamera()">STOP</button>
    </div>

    <div id="status" style="font-size: 3rem; font-weight: bold; border: 4px solid black; padding: 10px; display: inline-block; min-width: 300px;">
        OFFLINE
    </div>
    <div id="direction" style="font-size: 1.2rem; margin-top: 10px;"></div>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>

    <script>
        let faceMesh = null;
        let camera = null;

        const videoElement = document.getElementById('webcam');
        const canvasElement = document.getElementById('canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const statusDiv = document.getElementById('status');
        const directionDiv = document.getElementById('direction');

        function initFaceMesh() {
            faceMesh = new FaceMesh({
                locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
            });

            faceMesh.setOptions({
                maxNumFaces: 1,
                refineLandmarks: true,
                minDetectionConfidence: 0.6,
                minTrackingConfidence: 0.6
            });

            faceMesh.onResults(onResults);
        }

        function onResults(results) {
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                const landmarks = results.multiFaceLandmarks[0];
                
                // Landmark points for Iris and Eye corners
                const leftIris = landmarks[468];
                const rightIris = landmarks[473];
                const leftInner = landmarks[133];
                const leftOuter = landmarks[33];
                const rightInner = landmarks[362];
                const rightOuter = landmarks[263];

                // Calculate relative position (0.0 to 1.0)
                // We calculate how far the iris is between the inner and outer corners
                const leftGaze = (leftIris.x - leftOuter.x) / (leftInner.x - leftOuter.x);
                const rightGaze = (rightIris.x - rightInner.x) / (rightOuter.x - rightInner.x);
                
                const avgGaze = (leftGaze + rightGaze) / 2;

                // Thresholds for "Bored" vs "Focus"
                // .35 to .65 is generally "Center"
                if (avgGaze < 0.38) {
                    statusDiv.innerText = "BORED";
                    statusDiv.style.background = "yellow";
                    directionDiv.innerText = "Looking Left ðŸ‘ˆ";
                } else if (avgGaze > 0.62) {
                    statusDiv.innerText = "BORED";
                    statusDiv.style.background = "yellow";
                    directionDiv.innerText = "Looking Right ðŸ‘‰";
                } else {
                    statusDiv.innerText = "FOCUS";
                    statusDiv.style.background = "#00ff00";
                    directionDiv.innerText = "Center ";
                }

                // Visual debug dots
                drawDot(leftIris, "red");
                drawDot(rightIris, "red");
            } else {
                statusDiv.innerText = "NO FACE";
                statusDiv.style.background = "white";
                directionDiv.innerText = "";
            }
        }

        function drawDot(point, color) {
            canvasCtx.fillStyle = color;
            canvasCtx.beginPath();
            canvasCtx.arc(point.x * canvasElement.width, point.y * canvasElement.height, 3, 0, 2 * Math.PI);
            canvasCtx.fill();
        }

        async function startCamera() {
            if (!faceMesh) initFaceMesh();
            
            camera = new Camera(videoElement, {
                onFrame: async () => {
                    await faceMesh.send({image: videoElement});
                },
                width: 640,
                height: 480
            });
            camera.start();
            statusDiv.innerText = "STARTING...";
        }

        function stopCamera() {
            if (camera) {
                camera.stop();
                statusDiv.innerText = "OFFLINE";
                statusDiv.style.background = "white";
                directionDiv.innerText = "";
                canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            }
        }
    </script>
</body>
</html>